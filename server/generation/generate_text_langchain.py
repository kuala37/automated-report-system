from langchain_core.messages import HumanMessage, SystemMessage
from .langChainGiga import get_gigachat_client  


def generate_text(prompt):
    """
    Генерирует текст по промпту с использованием GigaChat API.

    Аргументы:
        prompt (str): Текстовый запрос (промпт).

    Возвращает:
        str: Сгенерированный текст.
    """
    # Получаем клиент GigaChat
    giga = get_gigachat_client()

    # Создаем сообщение
    messages = [SystemMessage(content=
            "Ты профессиональный аналитик, который составляет подробные отчеты о продажах. "
            "Отчет должен быть структурированным и содержать следующие разделы: "
            "1. Общий объем продаж. "
            "2. Основные тренды (рост или снижение продаж). "
            "3. Причины изменений. "
            "4. Рекомендации по улучшению продаж. "
            "Используй только факты и данные, избегай субъективных оценок."),
              HumanMessage(content=prompt)]


    # Генерируем текст
    response = giga.invoke(messages)
    return response.content

def generate_text_with_params(prompt, temperature=0.75, max_tokens=8000, top_p=0.9, n=1):
    """
    Генерирует текст по промпту с настраиваемыми параметрами.

    Аргументы:
        prompt (str): Текстовый запрос (промпт).
        temperature (float): Параметр "творчества" (по умолчанию 0.75).
        max_tokens (int): Максимальное количество токенов в ответе (по умолчанию 25000).
        top_p (float): Параметр разнообразия (по умолчанию 0.9).
        n (int): Количество вариантов ответа (по умолчанию 1).

    Возвращает:
        str: Сгенерированный текст.
    """
    giga = get_gigachat_client()

    messages = [SystemMessage(content="""
        Ты - эксперт по написанию профессиональных отчетов и документов любого типа. Твоя задача - создавать четкие, структурированные и информативные отчеты, адаптированные под конкретную область знаний и цель документа.

        При написании руководствуйся следующими принципами:

        1. ОПРЕДЕЛЕНИЕ ТИПА ОТЧЕТА:
        * Научный отчет/статья: включай введение, методологию, результаты, обсуждение, выводы
        * Лабораторная работа: включай цель, оборудование, ход работы, наблюдения, расчеты, выводы
        * Бизнес-отчет: включай обзор, анализ данных, выводы, рекомендации, прогнозы
        * Технический отчет: включай спецификации, методологию, наблюдения, заключения
        * Учебная работа: включай теоретическую часть, практическую часть, анализ, выводы

        2. СТРУКТУРА И СТИЛЬ:
        * Используй логичную структуру с четкими разделами и подразделами
        * Применяй соответствующую терминологию выбранной области знаний
        * Поддерживай формальный или научный стиль письма, избегай разговорных выражений
        * Используй точные формулировки и конкретные данные
        * Обеспечивай логическую связность между разделами и последовательность изложения

        3. СОДЕРЖАНИЕ:
        * Опирайся на актуальные научные концепции и методологии
        * Представляй информацию объективно, основываясь на фактах и данных
        * Если требуется, включай формулы, расчеты и математические выкладки
        * Делай выводы, основанные на логике и представленных данных
        * При необходимости предлагай обоснованные рекомендации

        4. АДАПТАЦИЯ К ЗАПРОСУ:
        * Анализируй запрос пользователя для определения области знаний
        * Подстраивай уровень сложности под предполагаемую аудиторию
        * При отсутствии конкретных данных используй правдоподобные примеры
        * Выделяй ключевые понятия и определения при необходимости

        5. ОБЩИЕ ТРЕБОВАНИЯ:
        * Избегай субъективных мнений и необоснованных утверждений
        * Используй профессиональный язык, но избегай чрезмерного усложнения
        * Фокусируйся на анализе и интерпретации, а не только на описании
        * При отсутствии точных данных четко обозначай предположения и ограничения

        Создавай отчеты, которые точно соответствуют запросу, имеют академический или профессиональный уровень и могут быть использованы в соответствующем контексте.
        """),
              HumanMessage(content=prompt)]

    response = giga.invoke(
        messages,
        temperature=temperature,
        max_tokens=max_tokens,
        top_p=top_p,
        n=n,
    )
    return response.content

def generate_long_text(prompt, chunk_size=1000):
    """
    Генерирует длинный текст, разбивая промпт на части.

    Аргументы:
        prompt (str): Текстовый запрос (промпт).
        chunk_size (int): Максимальная длина части промпта (по умолчанию 1000 символов).

    Возвращает:
        str: Сгенерированный текст.
    """
    # Разделение промпта на части
    chunks = [prompt[i:i + chunk_size] for i in range(0, len(prompt), chunk_size)]

    generated_text = ""

    # Генерация текста для каждой части
    for chunk in chunks:
        try:
            chunk_text = generate_text(chunk)
            generated_text += chunk_text + "\n\n"
        except Exception as e:
            print(f"Ошибка при генерации части текста: {e}")
            continue

    return generated_text

# Пример использования
if __name__ == "__main__":
    try:
        # Получение Access Token
        giga = get_gigachat_client()

        # Пример генерации текста
        prompt = "Напиши подробный отчет о продажах за последний квартал."
        generated_text = generate_text(prompt)
        print("Сгенерированный текст:")
        print(generated_text)

        # Пример генерации текста с параметрами
        generated_text = generate_text_with_params(
            prompt,
            temperature=0.5,  # Более "творческий" ответ
            max_tokens=1000,  # Ограничение длины ответа
            top_p=0.95,       # Больше разнообразия
            n=2               # Два варианта ответа
        )
        print("Сгенерированный текст с параметрами:")
        print(generated_text)

        # Пример генерации длинного текста
        long_prompt = (
            "Напиши подробный отчет о продажах за последний квартал. "
            "Включи информацию о продажах в категориях электроники, бытовой техники и одежды. "
            "Укажи основные тренды, такие как рост или снижение продаж, и причины этих изменений. "
            "Также добавь рекомендации по улучшению продаж в следующем квартале."
        )
        generated_text = generate_long_text(long_prompt)
        print("Сгенерированный длинный текст:")
        print(generated_text)

    except Exception as e:
        print(e)